# ADR 0005: Idempotency Pattern

> **Project:** Fedora Phoenix
> **Status:** âœ… Accepted
> **Date:** 2025-12-26
> **Refers to:** [ADR 0002](./adr-0002-block-architecture.md) (Procedural Flow)

---

## ğŸ“‹ Context (èƒŒæ™¯)

é›–ç„¶ [ADR 0002](./adr-0002-block-architecture.md) å®šç¾©äº†æ•´é«”åŸ·è¡Œæµç¨‹æ˜¯ç·šæ€§çš„ (Step 1 â†’ Step 2)ï¼Œä½†å¦‚æœå…§éƒ¨çš„åŸå­æ“ä½œåƒ…åƒ…æ˜¯åŸ·è¡ŒæŒ‡ä»¤ (å¦‚ `mkdir`, `git clone`)ï¼Œæœƒå°è‡´ç¨‹å¼æ¥µåº¦è„†å¼±ã€‚

### æ ¸å¿ƒå•é¡Œ

| ç‰¹æ€§ | Script (è…³æœ¬) | Playbook (åŠ‡æœ¬) |
|------|--------------|----------------|
| **å¯é‡è¤‡åŸ·è¡Œæ€§** | âŒ é€šå¸¸åªèƒ½è·‘ä¸€æ¬¡ | âœ… å¯ä»¥è·‘ç„¡æ•¸æ¬¡ |
| **å¤±æ•—æ¢å¾©** | âŒ éœ€è¦æ‰‹å‹•æ¸…ç† | âœ… è‡ªå‹•ä¿®å¾©ç‹€æ…‹ |
| **éƒ¨åˆ†å®Œæˆè™•ç†** | âŒ å ±éŒ¯ä¸¦ä¸­æ–· | âœ… æ¥çºŒæœªå®Œæˆéƒ¨åˆ† |

ç•¶ç¶²è·¯ä¸­æ–·æˆ–éƒ¨åˆ†å¤±æ•—æ™‚ï¼Œæˆ‘å€‘éœ€è¦èƒ½å¤ **é‡æ–°åŸ·è¡Œç¨‹å¼ (Rerun)** ä¾†ä¿®å¾©ç‹€æ…‹ï¼Œè€Œä¸æœƒç ´å£å·²ç¶“å®Œæˆçš„éƒ¨åˆ†ã€‚

---

## ğŸ¯ Decision (æ±ºç­–)

æ‰€æœ‰çš„ **Act Functions** å¿…é ˆéµå¾ªã€Œ**æœŸæœ›ç‹€æ…‹ (Desired State)**ã€æ¨¡å¼ï¼Œè€Œéå–®ç´”çš„å‹•ä½œåŸ·è¡Œã€‚

### 1. å‘½åå…¬ç´„ï¼šThe "Ensure" Prefix

å‡½æ•¸å‘½åæ‡‰åæ˜ ã€Œ**ç¢ºä¿ç‹€æ…‹**ã€çš„æ„åœ–ï¼Œè€Œéã€ŒåŸ·è¡Œå‹•ä½œã€ã€‚

| âŒ Bad (Imperative) | âœ… Good (Declarative) |
|---------------------|----------------------|
| `InstallPackages()` | `EnsurePackages()` |
| `CreateSymlink()` | `EnsureSymlink()` |
| `MountDisk()` | `EnsureDeviceMounted()` |
| `CloneRepo()` | `EnsureGitRepo()` |

---

### 2. å¯¦ä½œæ¨¡å¼ï¼šCheck-Diff-Act

æ¯å€‹å‡½æ•¸å…§éƒ¨å¿…é ˆå¯¦ä½œ**å†ªç­‰æ€§ (Idempotency)** é‚è¼¯ã€‚æ¨™æº–çµæ§‹å¦‚ä¸‹ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Check (Current State)                                â”‚
â”‚    æª¢æŸ¥ç›®æ¨™ç›®å‰çš„ç‹€æ…‹                                      â”‚
â”‚    â€¢ æª”æ¡ˆå­˜åœ¨å—ï¼Ÿ                                         â”‚
â”‚    â€¢ Symlink æŒ‡å‘å“ªè£¡ï¼Ÿ                                   â”‚
â”‚    â€¢ å¥—ä»¶å·²å®‰è£å—ï¼Ÿ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Diff (Comparison)                                    â”‚
â”‚    æ¯”å°æ˜¯å¦ç¬¦åˆæœŸæœ›ç‹€æ…‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‹€æ…‹ç¬¦åˆ       â”‚         â”‚ ç‹€æ…‹ä¸ç¬¦åˆ      â”‚
â”‚ â†’ Do Nothing  â”‚         â”‚ â†’ Continue    â”‚
â”‚ â†’ Log & Returnâ”‚         â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. Act (Reconciliation)             â”‚
                    â”‚    åŸ·è¡Œä¿®æ­£å‹•ä½œ                       â”‚
                    â”‚    â€¢ å®‰è£ / ä¿®æ”¹ / è¦†è“‹               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. éŒ¯èª¤å®¹å¿èˆ‡ä¿®æ­£

å°æ–¼ã€Œ**å·²å­˜åœ¨ä½†éŒ¯èª¤**ã€çš„ç‹€æ…‹ (ä¾‹å¦‚ Symlink æŒ‡å‘éŒ¯èª¤è·¯å¾‘)ï¼Œç¨‹å¼æ‡‰ï¼š

| ç­–ç•¥ | é©ç”¨å ´æ™¯ | ç¯„ä¾‹ |
|------|---------|------|
| **è‡ªå‹•ä¿®æ­£** | éç ´å£æ€§æ“ä½œ | `ln -sfn` å¼·åˆ¶è¦†è“‹é€£çµ |
| **å ±éŒ¯ä¸¦è¦æ±‚ä»‹å…¥** | ç ´å£æ€§æ“ä½œ | è¦†è“‹é‡è¦è³‡æ–™å‰è­¦å‘Š |

åœ¨è‡ªå‹•åŒ–å ´æ™¯ä¸­ï¼Œå‚¾å‘æ–¼ **Force/Override**ï¼Œä»¥ç¢ºä¿æœ€çµ‚çµæœçµ•å°ç¬¦åˆ `phoenix.yml`ã€‚

---

## ğŸ’¡ Practical Examples (å¯¦ä¾‹)

### Example 1: Symlink Management

#### âŒ Imperative (Script)

```go
// ç›´æ¥åŸ·è¡Œå‘½ä»¤ï¼Œä¸æª¢æŸ¥ç‹€æ…‹
func CreateSymlink(target, link string) {
    exec.Command("ln", "-s", target, link).Run()
}
```

**å•é¡Œ**: å¦‚æœ `link` å·²å­˜åœ¨ï¼Œå ±éŒ¯ä¸¦ Crashã€‚

#### âœ… Declarative (Playbook)

```go
func EnsureSymlink(target, link string) error {
    // Check: è®€å–ç•¶å‰ symlink ç‹€æ…‹
    currentTarget, err := os.Readlink(link)

    // Diff: æ¯”å°æ˜¯å¦ç¬¦åˆæœŸæœ›
    if err == nil && currentTarget == target {
        log.Info("Symlink already correct, skipping")
        return nil
    }

    // Act: ä¿®æ­£ç‹€æ…‹
    return exec.Command("ln", "-sfn", target, link).Run()
}
```

**å„ªå‹¢**: å¯é‡è¤‡åŸ·è¡Œï¼Œè‡ªå‹•ä¿®æ­£éŒ¯èª¤ç‹€æ…‹ã€‚

---

### Example 2: Git Repository Cloning

#### âŒ Imperative (Script)

```go
func CloneRepo(url, dest string) {
    exec.Command("git", "clone", url, dest).Run()
}
```

**å•é¡Œ**: å¦‚æœç›®éŒ„å·²å­˜åœ¨ï¼Œå ±éŒ¯ä¸¦ Crashã€‚

#### âœ… Declarative (Playbook)

```go
func EnsureGitRepo(url, dest string) error {
    // Check: æª¢æŸ¥ç›®éŒ„æ˜¯å¦å­˜åœ¨
    if _, err := os.Stat(dest); err == nil {
        log.Infof("Repository %s already exists, skipping", dest)
        return nil
        // æˆ–: åŸ·è¡Œ git pull æ›´æ–° (è¦–ç­–ç•¥è€Œå®š)
    }

    // Act: Clone repository
    return exec.Command("git", "clone", url, dest).Run()
}
```

**å„ªå‹¢**: å®‰å…¨å¯é‡å…¥ï¼Œä¸æœƒå› ç›®éŒ„å·²å­˜åœ¨è€Œå¤±æ•—ã€‚

---

## âš–ï¸ Consequences (å¾Œæœ)

### âœ… æ­£é¢å½±éŸ¿ (Pros)

| å„ªå‹¢ | èªªæ˜ |
|------|------|
| **å¯é‡å…¥æ€§ (Re-entrancy)** | ç¨‹å¼å¯ä»¥éš¨æ™‚ä¸­æ–·ä¸¦é‡æ–°åŸ·è¡Œï¼Œå°±åƒ Ansible æˆ– Terraform |
| **å¼·å¥æ€§ (Robustness)** | å°æ–¼ã€Œéƒ¨åˆ†å®Œæˆã€çš„ç’°å¢ƒ (ä¾‹å¦‚ä¸Šæ¬¡è·‘åˆ°ä¸€åŠæ–·é›»)ï¼Œèƒ½è‡ªå‹•æ¥çºŒä¸¦ä¿®å¾© |
| **å¯é æ¸¬æ€§** | åŸ·è¡Œçµæœå§‹çµ‚ç¬¦åˆ Blueprint å®šç¾©ï¼Œç„¡è«–åŸ·è¡Œå¹¾æ¬¡ |

### âŒ è² é¢å½±éŸ¿ (Cons)

| åŠ£å‹¢ | èªªæ˜ | ç·©è§£æªæ–½ |
|------|------|----------|
| **ä»£ç¢¼é‡å¢åŠ ** | æ¯å€‹å‡½æ•¸éƒ½éœ€è¦å…ˆå¯«æª¢æŸ¥é‚è¼¯ï¼Œæ¯”å–®ç´”å‘¼å«æŒ‡ä»¤ç¹ç‘£ | ä½¿ç”¨ AI è¼”åŠ©ç”Ÿæˆæ¨£æ¿ä»£ç¢¼ |
| **æ€§èƒ½é–‹éŠ·** | é¡å¤–çš„ç‹€æ…‹æª¢æŸ¥æœƒå¢åŠ åŸ·è¡Œæ™‚é–“ | ä½¿ç”¨é«˜æ•ˆçš„æª¢æŸ¥æ–¹å¼ (å¦‚ `rpm -q` è€Œé `dnf list`) |

---

## ğŸ“ Implementation Guidelines

æ‰€æœ‰ Act Functions éƒ½æ‡‰éµå¾ªæ­¤æ¨¡å¼ï¼š

```go
func EnsureXXX(...) error {
    // 1. Check: ç²å–ç•¶å‰ç‹€æ…‹
    currentState := getCurrentState()

    // 2. Diff: æ¯”å°æœŸæœ›ç‹€æ…‹
    if currentState == desiredState {
        log.Info("Already in desired state, skipping")
        return nil
    }

    // 3. Act: åŸ·è¡Œä¿®æ­£å‹•ä½œ
    if err := reconcile(); err != nil {
        return fmt.Errorf("failed to reconcile: %w", err)
    }

    return nil
}
```

é€™å€‹æ¨¡å¼ç¢ºä¿æ‰€æœ‰æ“ä½œéƒ½æ˜¯**å†ªç­‰çš„ (Idempotent)**ï¼Œå¯ä»¥å®‰å…¨åœ°é‡è¤‡åŸ·è¡Œã€‚
