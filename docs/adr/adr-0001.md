# ADR 0001: 使用純 Go 靜態編譯程式作為單一系統還原工具

> **Project:** Fedora Phoenix
> **Status:** ✅ Accepted
> **Date:** 2025-12-26
> **Authors:** You & Gemini
> **Context:** Fedora Workstation on Framework Laptop (Personal & Professional Use)

---

## 📋 Context (背景)

我們需要在 Framework Laptop 上運行 Fedora Linux，該環境具有雙重用途：
- **個人技術探索**：高風險操作、核心實驗
- **公司商業軟體開發**：穩定性要求

### 目前的維運痛點

#### 1. 系統高頻重灌需求
為保持系統純淨及從實驗失敗中復原，Root 分區 (`/`) 經常需要格式化重灌 (Nuke and Pave)。

#### 2. 現有工具的侷限性

| 工具 | 問題 |
|------|------|
| **Shell Script** | • 缺乏冪等性 (Idempotency)<br>• 錯誤處理困難<br>• 程式碼難以維護（義大利麵條式代碼） |
| **Ansible** | • 存在「雞生蛋」問題（需先安裝 Python/Pip/Git）<br>• 執行速度較慢<br>• 對單機還原而言過於臃腫 |

#### 3. 資料隔離需求
公司資料存放於獨立的 **LUKS 加密分區**，重灌時不格式化，需在還原過程中安全解鎖並掛載。

#### 4. 體驗目標
追求 **"Single Binary"** 體驗：下載即執行，無須預先配置環境，達成「世界線回溯」級別的自動化。

---

## 🎯 Decision (決策)

我們決定開發一個名為 **`fedora-phoenix`** 的客製化 CLI 工具，採用 **Golang 編寫並靜態編譯**，以此取代 Shell Scripts 或 Ansible Playbooks。

### 1. 技術棧選擇

```yaml
語言:     Go (Golang)
發佈形式: Static Single Binary (無依賴)
目標平台: Fedora Linux (GNOME) ONLY
```

### 2. 架構核心 (The "Pure Go" Strategy)

我們拒絕使用 Go 呼叫 Ansible 的 Wrapper 模式，改為在 Go 內部實作輕量級的 DSL (`internal/ops`)。

#### 核心原則
- **放棄通用性**：不支援跨平台，邏輯中硬編碼 `dnf`, `systemd`, `cryptsetup` 等指令
- **原生冪等函數**：自行實作 `EnsurePackages`, `EnsureService`, `EnsureSymlink` 等函數
- **狀態檢查**：利用 `rpm -q` 或 `os.Stat` 進行狀態檢查，僅在必要時執行變更

### 3. 硬體與分區策略

本工具依賴特定的磁碟佈局：

| 分區 | 用途 | 策略 |
|------|------|------|
| **Root Partition** (`/`) | 系統分區 | 每次重灌時格式化 |
| **Data Partition** (`/dev/nvme0n1p4`) | LUKS 加密分區 | 保留公司資料與大型 Docker Image |
| **Bind Mount** | 資料映射 | 透過 Bind Mount 或 Symlink 映射回 User Home |

### 4. 安全性與互動

#### 密碼處理
- 利用 Go 的 `golang.org/x/term` 處理密碼輸入（不回顯）
- 利用 `os/exec` 的 `StdinPipe` 將密碼傳遞給 `cryptsetup`
- 避免密碼洩漏於 Process List 或 Log

#### Fail Fast 原則
任何關鍵步驟（如 Mount, DNF Install）回傳非 0 exit code 即觸發 **Panic 中止**，防止偽陽性結果。

---

## ⚖️ Consequences (後果)

### ✅ 正面影響 (Pros)

| 優勢 | 說明 |
|------|------|
| **零依賴啟動** | 在全新的 Fedora Live 系統上，僅需 `curl` 下來即可執行 |
| **極致效能** | 去除 Python 直譯器開銷，直接呼叫 System Binaries |
| **型別安全與除錯** | 編譯期即可抓錯，運行時錯誤有完整的 Stack Trace |
| **完全掌控** | 每一行執行邏輯皆透明，無黑盒子行為 |

### ❌ 負面影響 (Cons)

| 風險 | 說明 |
|------|------|
| **維護成本** | 需自行維護 `internal/ops` 內的底層邏輯，無法利用 Ansible 社群資源 |
| **不可移植** | 與 Fedora 版本及 Partition 架構高度耦合（但這符合我們的預期） |

---

## ✔️ Compliance (合規性檢查)

- ✅ 符合使用者「專精 Fedora」與「硬派工程師浪漫」的非功能性需求
- ✅ 資料安全符合公司代碼隔離原則（LUKS Encrypted）
